# core-github-actions-templates

<!-- action-docs-header source="build/action.yml" -->
<!-- action-docs-description source="build/action.yml" -->

### Example usage in a full workflow

```yaml
name: Build and Deploy to Kubernetes

on:
  push:
    branches: [trunk]
  pull_request:
    branches: [trunk]
  workflow_dispatch:
    branches:
      - feature/github-action

permissions:
  actions: read
  contents: read
  id-token: write
  security-events: write
  issues: read
  checks: write
  pull-requests: write

jobs:
  unittests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: 3lvia/core-github-actions-templates/unittest@trunk

  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/trunk' # only run analyze on PR
    steps:
      - uses: 3lvia/core-github-actions-templates/analyze@trunk

  build:
    name: Build and Scan
    runs-on: ubuntu-latest
    environment: build
    steps:
      - uses: 3lvia/core-github-actions-templates/build@trunk
        with:
          name: demo-api
          namespace: core
          dockerfile: core-demo-api/Dockerfile
          AZURE_CLIENT_ID: ${{ vars.ACR_CLIENT_ID }}

  deploy_dev:
    name: Deploy Dev
    needs: [build, unittests]
    # if: github.ref == 'refs/heads/trunk'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: 3lvia/core-github-actions-templates/deploy@trunk
        with:
          name: demo-api
          namespace: core
          environment: dev
          AZURE_CLIENT_ID: ${{ vars.AKS_CLIENT_ID }}
          helmValuesPath: '.github/deploy/values.yaml'

  deploy_test:
    name: Deploy Test
    needs: [deploy_dev]
    runs-on: ubuntu-latest
    environment: test
    if: github.ref == 'refs/heads/trunk'
    steps:
      - uses: 3lvia/core-github-actions-templates/deploy@trunk
        with:
          name: demo-api
          namespace: core
          environment: test
          AZURE_CLIENT_ID: ${{ vars.AKS_CLIENT_ID }}
          helmValuesPath: '.github/deploy/values.yaml'

  deploy_prod:
    name: Deploy Prod
    needs: [deploy_test]
    runs-on: ubuntu-latest
    environment: prod
    if: github.ref == 'refs/heads/trunk'
    steps:
      - uses: 3lvia/core-github-actions-templates/deploy@trunk
        with:
          name: demo-api
          namespace: core
          environment: prod
          AZURE_CLIENT_ID: ${{ vars.AKS_CLIENT_ID }}
          helmValuesPath: '.github/deploy/values.yaml'
```

<!-- action-docs-inputs source="build/action.yml" -->
<!-- action-docs-usage source="build/action.yml" project="core-github-actions-templates" version="trunk" -->

<!-- action-docs-header source="deploy/action.yml" -->
<!-- action-docs-description source="deploy/action.yml" -->
<!-- action-docs-inputs source="deploy/action.yml" -->
<!-- action-docs-usage source="deploy/action.yml" project="core-github-actions-templates" version="trunk" -->

<!-- action-docs-header source="trivy-iac-scan/action.yml" -->
<!-- action-docs-description source="trivy-iac-scan/action.yml" -->
<!-- action-docs-inputs source="trivy-iac-scan/action.yml" -->
<!-- action-docs-usage source="trivy-iac-scan/action.yml" project="core-github-actions-templates" version="trunk" -->

<!-- action-docs-header source="terraform-format/action.yml" -->
<!-- action-docs-description source="terraform-format/action.yml" -->
<!-- action-docs-inputs source="terraform-format/action.yml" -->
<!-- action-docs-usage source="terraform-format/action.yml" project="core-github-actions-templates" version="trunk" -->

# Development

## Setup

Install the dependencies using [yarn](https://yarnpkg.com):

```bash
yarn install
```

## Action documentation

We use [action-docs](https://github.com/npalm/action-docs) to auto-generate the documentation for the actions.
To add documentation for your new action, add these tags to the `README.md` file:

```markdown
<!-- action-docs-header source="my-new-action/action.yml" -->
<!-- action-docs-description source="my-new-action/action.yml" -->
<!-- action-docs-inputs source="my-new-action/action.yml" -->
<!-- action-docs-usage source="my-new-action/action.yml" project="core-github-actions-templates" version="trunk" -->
```

and add the action to the comma-separated list `ACTION_DIRS` in [`.github/workflows/autogenerate-docs.yml`](.github/workflows/autogenerate-docs.yml):

```yaml
name: Generate action documentation for ${{ matrix.action-file }}
runs-on: ubuntu-latest
env:
  ACTION_DIRS: 'build,deploy,trivy-iac-scan,terraform-format,my-new-action' # Add your action here
steps:
```

The documentation will then be autogenerated and commited on push to the `trunk` branch.

### Check autogenerated documentation locally

You can run [action-docs](https://github.com/npalm/action-docs) locally to check the generated documentation:

```bash
yarn gen-docs new-action/action.yaml
cat README.md
```

## Formatting

We use [prettier](https://prettier.io) to format the README and yaml files:

```bash
yarn format
# OR
yarn format --end-of-line crlf
```
