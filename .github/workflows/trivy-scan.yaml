name: Scan Terraform code with Trivy

on:
  workflow_call:
    inputs:
      path:
        description: 'Path to IaC to scan.'
        required: false
        default: '.'
        type: string
      skip-dirs:
        description: 'Comma-separated list of directories to skip.'
        required: false
        type: string
      severity:
        description: 'Severity levels to scan for. See https://github.com/aquasecurity/trivy-action?tab=readme-ov-file#inputs for more information.'
        required: false
        default: 'CRITICAL,HIGH,MEDIUM'
        type: string
      upload-report:
        description: 'Upload Trivy report to GitHub Security tab. GitHub Advanced Security must be enabled for the repository to use this feature.'
        required: false
        default: true
        type: boolean
      ignore-unfixed:
        description: 'Ignore unpatched/unfixed vulnerabilities.'
        required: false
        default: false
        type: boolean

jobs:
  trivy_scan:
    name: 'Scan Terraform code with Trivy'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    env:
      TRIVY_JSON: trivy.json
      TRIVY_SARIF: trivy.sarif
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner in IaC mode
        id: trivy_check
        uses: aquasecurity/trivy-action@0.16.1
        with:
          scan-type: 'config'
          format: 'json'
          output: ${{ env.TRIVY_JSON }}
          exit-code: '1'
          ignore-unfixed: ${{ inputs.ignore-unfixed }}
          severity: ${{ inputs.severity }}
          scan-ref: ${{ inputs.path }}
          skip-dirs: ${{ inputs.skip-dirs }}

      # This can be refactored when trivy-action supports multiple outputs via convert:
      # https://github.com/aquasecurity/trivy-action/issues/259
      - name: Run second Trivy vulnerability scanner in IaC mode for GitHub Security tab
        id: trivy_check_summary
        if: failure() && steps.trivy_check.outcome == 'failure' && inputs.upload-report
        uses: aquasecurity/trivy-action@0.16.1
        with:
          scan-type: 'config'
          format: 'sarif'
          output: ${{ env.TRIVY_SARIF }}
          exit-code: '0'
          ignore-unfixed: ${{ inputs.ignore-unfixed }}
          severity: ${{ inputs.severity }}
          scan-ref: ${{ inputs.path }}
          skip-dirs: ${{ inputs.skip-dirs }}

      # GitHub Security tab does not support SARIF files with `git::` or `https:/` URL's:
      # https://github.com/aquasecurity/trivy/issues/5003#issuecomment-1780415058
      - name: Workaround for Trivy SARIF output
        if: failure() && steps.trivy_check.outcome == 'failure' && inputs.upload-report && steps.trivy_check_summary.outcome == 'success'
        run: sed -i 's#git::https:/##g' "${{ env.TRIVY_SARIF }}"

      - name: Upload Trivy report to GitHub Security tab
        if: failure() && steps.trivy_check.outcome == 'failure' && inputs.upload-report && steps.trivy_check_summary.outcome == 'success'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.TRIVY_SARIF }}
          category: 'Trivy'
